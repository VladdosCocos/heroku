<!DOCTYPE html>
<html>
<head>
	<title>Ray Marching</title>
</head>
<body>
	<canvas id="cnv"></canvas>
	<style>*{margin: 0px;padding: 0px;}</style>
	<script>
    let cnv = document.getElementById('cnv');
let ctx = cnv.getContext('2d');

let w = window.innerWidth;
let h = window.innerHeight;

cnv.width = w;
cnv.height = h;

let ITTER = 100;
let MAX_DIST = 10;

const EX = vec(0.001, 0, 0);
const EY = vec(0, 0.001, 0);
const EZ = vec(0, 0, 0.001);


draw();

function getDist(p) {
	let sphere = vec(0, 0, 0);
	let sd = dist(p, sphere) -0.9;

	let pd = -p.z +0.8;

	let cube = vec(0, 0, 0);
	let q = sub(getAbs(p), vec(0.5,1,1));
	let cd = dist(getMax(q, 0), cube) + Math.min(Math.max(q.x, Math.max(q.y, q.z)), 0);

	return Math.min(pd, sd, cd);
}

function vec(x, y, z) {
	return {x, y, z};
}

function dist(a, b) {
	return Math.sqrt((a.x - b.x) ** 2 +(a.y - b.y) ** 2 +(a.z - b.z) ** 2);
}

function normilaze(a) {
	let l = dist(a, vec(0, 0, 0));
	return vec(a.x / l, a.y / l, a.z / l);
}

function sum(a, b) {
	return vec(a.x + b.x, a.y + b.y, a.z + b.z);
}

function sub(a, b) {
	return vec(a.x - b.x, a.y - b.y, a.z - b.z);
}

function dot(a, b) {
	return a.x * b.x + a.y * b.y + a.z * b.z;
}

function mul(a, v) {
	return vec(a.x * v, a.y * v, a.z * v);
}

function getAbs(p) {
	return vec(Math.abs(p.x), Math.abs(p.y), Math.abs(p.z));
}

function getMax(a, v) {
	return vec(Math.max(a.x, v), Math.max(a.y, v), Math.max(a.z, v));
}

function getNormal(p) {
	let d = getDist(p);
	let n = sub(vec(d, d, d), vec(getDist(sub(p, EX)), getDist(sub(p, EY)), getDist(sub(p, EZ))));
	return normilaze(n);
}

function light(p) {
	let lp = vec(-5, 5, -10);
	let ld = normilaze(sub(lp, p));
	let n = getNormal(p);
	let dif = dot(n, ld) * 0.5 + 0.5;
	return dif;
}

function rayMarching(ro, rd) {
	let p = vec(ro.x, ro.y, ro.z);
	for (let i = 0; i < ITTER; i++) {
		let d = getDist(p);
		if(d > MAX_DIST) break;
		p = sum(p, mul(rd, d));
		if(d < 0.1) {
			return light(p);
		}
	}
	return 0;
}

function draw() {
	const imgData = ctx.createImageData(w, h);
	let data = imgData.data;
	// position camera
	let ro = vec(-2, 0, 0);

	for (let i = 0; i < w; i++) {
		for (let j = 0; j < h; j++) {
			// x: -1, 1; y: -1, 1;
			let x = (i / w) * 2 -1;
			let y = (j / h) * 2 -1;

			x *= w / h;
			// direction ray
			let rd = vec(1, x, y);
			rd = normilaze(rd);

			// if(x*x + y*y < 1) col = 0;

			let col = rayMarching(ro, rd);
			col *= 255;

			let ind = (i + j * w) * 4;
			data[ind]     = col;
			data[ind + 1] = col;
			data[ind + 2] = col;
			data[ind + 3] = 255;
		}
	}
	ctx.putImageData(imgData, 0, 0);
}

  </script>
</body>
</html>
